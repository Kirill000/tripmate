{% extends "main/base.html" %}
{% load static %}

{% block extra_css %}
<link href="{% static "css/chat.css" %}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="chat-container">
  <h2 class="chat-header">–ß–∞—Ç –ø–æ –º–∞—Ä–∫–µ—Ä—É {{marker.id}}</h2>
  <small><b>–ü—É–Ω–∫—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏:</b> {{ marker.start_point }}</small><br>
  <small><b>–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:</b> {{ marker.end_point }}</small>
  <p class="chat-info">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: {{ to_user.username }} {% if to_user.userstatus.is_online %}(–û–Ω–ª–∞–π–Ω){% endif %}</p>

  <div id="chat-box" class="chat-box"></div>

  <form id="message-form" class="chat-form">
    <input id="to_user_id" type="hidden" name="to_user_id" value="{{ to_user.id }}">
    <input id="marker_id" type="hidden" name="marker_id" value="{{ marker.id }}">
    <textarea name="text" id="message-text" class="message-text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required></textarea>
    <button type="submit" class="submit-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>
</div>
{% endblock %}

{% block extra_js %}

<script>

  //let user_query_data = "{{ user_query_data }}";  // ‚Üê –∑–∞—Ä–∞–Ω–µ–µ –æ–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

  function loadMessages() {

    let box = document.getElementById('chat-box');
    let lastScrollTop = box.scrollTop;
    let user_id = "{{request.user.id}}";

    fetch("{% url 'get_messages' marker.id to_user.id %}")
      .then(res => res.json())
      .then(data => {
        let box = document.getElementById('chat-box');

        box.innerHTML = '';  // –û—á–∏—â–∞–µ–º —á–∞—Ç
        data.messages.forEach(m => {
          console.log(m);
          // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å .from-user, –µ—Å–ª–∏ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ - .to-user
          console.log(m.notify_type);
          let messageClass = m.from === '{{ request.user.username }}' ? 'from-user' : 'to-user';
          
          if (m.notify_type == 'user_query') {
            pickupMapLink = `<br><small><a href="https://yandex.ru/maps/?rtext={{user_query_data.lon}}%2C{{user_query_data.lat}}&z=11.2" target="_blank">üìç –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ: {{user_query_data.point}}</a></small>`;
            //https://yandex.ru/maps/?ll=-14.002575%2C49.972191&mode=search&pt=%2C53.202742353507254&sll={{user_query_data.pickup_lon}}%2C{{user_query_data.pickup_lat}}&text={{user_query_data.pickup_lon}}%2C{{user_query_data.lat}}&z=11.2
            box.innerHTML += `<p class="message ${messageClass}">
              <strong>${m.from}:</strong> ${m.text}
              ${pickupMapLink}
              <span class="timestamp">${m.timestamp.split(" ")[1]}</span><br>
              <button class="user-query-reply" id="decline">Decline</button>
              <button class="user-query-reply" id="approve">Approve</button>
            </p>`;
          
            
            document.getElementById("approve").addEventListener('click', function(e){
              e.preventDefault();
              SendMessage(1, "approve");
            })

            document.getElementById("decline").addEventListener('click', function(e){
              e.preventDefault();
              SendMessage(1, "decline");
            })
          } else {
            box.innerHTML += `<p class="message ${messageClass}"><strong>${m.from}:</strong> ${m.text} <span class="timestamp">${m.timestamp.split(" ")[1]}</span></p>`;
          }
        });
        box.scrollTop = box.scrollHeight; // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –¥–æ –∫–æ–Ω—Ü–∞
      });

    box.scrollTop = lastScrollTop;

  }

setInterval(loadMessages, 3000); // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—É—é 3 —Å–µ–∫—É–Ω–¥—ã
loadMessages();

document.getElementById('message-form').addEventListener('submit', function(e) {
  e.preventDefault();
  SendMessage(0, this.id);
});

function SendMessage(notify, id){

  let formData = new FormData();

  formData.append("to_user_id", document.getElementById('to_user_id').value);
  formData.append("marker_id", document.getElementById('marker_id').value);

  if (!notify) {
    msg = document.getElementById('message-text').value;
  } else {
    if (id == 'decline'){
      msg = "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{request.user}} –æ—Ç–∫–∞–∑–∞–ª –í–∞–º –≤ –ø–æ–µ–∑–¥–∫–µ :(";
    } else {
      msg = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{request.user}} –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–µ–∑–¥–∫—É!";
    }
  }
  formData.append('notify_type', id);
  formData.append("text", msg);

  fetch("{% url 'send_message' %}", {
    method: 'POST',
    headers: {'X-CSRFToken': '{{ csrf_token }}'},
    body: formData
  }).then(() => {
    document.getElementById('message-text').value = ''; // –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    loadMessages(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç
  });
}

</script>

{% endblock %} 
